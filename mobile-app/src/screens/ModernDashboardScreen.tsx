// Modern Dashboard Screen with Real Call Detection
// Integrates with ModernCallDetectionService for Android 15+

import React, { useState, useEffect, useCallback } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  Alert,
  RefreshControl,
  Dimensions,
} from 'react-native';
import { useNavigation, useFocusEffect } from '@react-navigation/native';
import { ModernCallDetectionService } from '../services/ModernCallDetectionService';
import ApiService from '../services/ApiService';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { AuthBus } from '../utils/AuthBus';
import theme from '../styles/theme';

interface User {
  id: string;
  email: string;
  firstName: string;
  lastName: string;
  phoneNumber: string;
  role: string;
  businessId?: string;
  isGdprCompliant: boolean;
}

interface DashboardStats {
  totalCalls: number;
  missedCalls: number;
  responseRate: number;
  avgResponseTime: string;
  activeConversations: number;
}

interface CallDetectionStatus {
  isInitialized: boolean;
  isListening: boolean;
  hasPermissions: boolean;
  androidVersion: string;
  lastCallTime?: string;
}

interface ActivityItem {
  id: string;
  icon: string;
  title: string;
  subtitle: string;
  status: string;
  timestamp: number;
}

function ModernDashboardScreen() {
  const navigation = useNavigation<any>();
  const [user, setUser] = useState<User | null>(null);
  const [stats, setStats] = useState<DashboardStats>({
    totalCalls: 87,
    missedCalls: 12,
    responseRate: 86,
    avgResponseTime: '2m 15s',
    activeConversations: 5,
  });
  const [callDetectionStatus, setCallDetectionStatus] = useState<CallDetectionStatus>({
    isInitialized: false,
    isListening: false,
    hasPermissions: false,
    androidVersion: 'Unknown',
  });
  const [recentActivity, setRecentActivity] = useState<ActivityItem[]>([]);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [lastUpdated, setLastUpdated] = useState<Date>(new Date());

  const callDetectionService = ModernCallDetectionService.getInstance();

  useEffect(() => {
    initializeScreen();
    setupCallDetectionListener();
    
    return () => {
      // Cleanup listeners when component unmounts
      callDetectionService.removeMissedCallListener(handleMissedCall);
    };
  }, []);

  useFocusEffect(
    useCallback(() => {
      // Refresh data when screen comes into focus
      refreshCallDetectionStatus();
      loadRecentActivity();
    }, [])
  );

  const initializeScreen = async () => {
    try {
      console.log('üöÄ Initializing dashboard...');
      await loadUserData();
      await loadDashboardData();
      await refreshCallDetectionStatus();
      await loadRecentActivity();
      await testBackendConnection();
      console.log('‚úÖ Dashboard initialization complete');
    } catch (error) {
      console.error('‚ùå Error initializing dashboard:', error);
    }
  };

  const testBackendConnection = async () => {
    try {
      const response = await ApiService.getInstance().healthCheck();
      if (response.success) {
        console.log('‚úÖ Backend connection successful:', response.data);
      } else {
        console.log('‚ùå Backend connection failed:', response.error);
      }
    } catch (error) {
      console.log('‚ùå Backend connection error:', error);
    }
  };

  const testDatabaseConnection = async () => {
    try {
      console.log('üîç Testing database connection...');
      
      // Test 1: Health Check
      const healthResponse = await ApiService.getInstance().healthCheck();
      console.log('üìä Health Check:', healthResponse);
      
      // Test 2: Try to get dashboard stats (this will test database queries)
      const statsResponse = await ApiService.getInstance().getDashboardStats();
      console.log('üìà Dashboard Stats:', statsResponse);
      
      // Test 3: Try to sync a test missed call
      const testMissedCall = {
        id: 'test-' + Date.now(),
        phoneNumber: '+359888123456',
        timestamp: new Date().toISOString(),
        duration: 0,
        type: 'missed',
        smsSent: false,
        smsSentAt: null
      };
      
      const syncResponse = await ApiService.getInstance().syncMissedCalls([testMissedCall]);
      console.log('üìû Sync Test:', syncResponse);
      
      // Show results to user
      Alert.alert(
        '–†–µ–∑—É–ª—Ç–∞—Ç –æ—Ç —Ç–µ—Å—Ç–∞ –Ω–∞ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏',
        `–ó–¥—Ä–∞–≤–æ—Å–ª–æ–≤–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞: ${healthResponse.success ? '‚úÖ –£—Å–ø–µ—à–Ω–æ' : '‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ'}\n` +
        `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${statsResponse.success ? '‚úÖ –£—Å–ø–µ—à–Ω–æ' : '‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ'}\n` +
        `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ${syncResponse.success ? '‚úÖ –£—Å–ø–µ—à–Ω–æ' : '‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ'}\n\n` +
        `–ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∫–æ–Ω–∑–æ–ª–∞—Ç–∞ –∑–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏.`,
        [{ text: 'OK' }]
      );
      
    } catch (error) {
      console.error('‚ùå Database connection test failed:', error);
      Alert.alert(
        '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç –Ω–∞ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏',
        `–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞: ${error}`,
        [{ text: 'OK' }]
      );
    }
  };

  const setupCallDetectionListener = () => {
    callDetectionService.addMissedCallListener(handleMissedCall);
  };

  const handleMissedCall = (event: any) => {
    console.log('üìû New missed call received:', event);
    
    // Update stats
    setStats(prev => ({
      ...prev,
      totalCalls: prev.totalCalls + 1,
      missedCalls: prev.missedCalls + 1,
    }));

    // Add to recent activity
    const newActivity: ActivityItem = {
      id: `call_${Date.now()}`,
      icon: 'üìû',
      title: '–ü—Ä–æ–ø—É—Å–Ω–∞—Ç–æ –æ–±–∞–∂–¥–∞–Ω–µ',
      subtitle: `${event.phoneNumber} ‚Ä¢ ${event.formattedTime}`,
      status: 'AI –æ—Ç–≥–æ–≤–æ—Ä',
      timestamp: event.timestamp,
    };

    setRecentActivity(prev => [newActivity, ...prev.slice(0, 9)]);
    setLastUpdated(new Date());

    // Show notification
    Alert.alert(
      '–ü—Ä–æ–ø—É—Å–Ω–∞—Ç–æ –æ–±–∞–∂–¥–∞–Ω–µ',
      `–û—Ç: ${event.phoneNumber}\n–í—Ä–µ–º–µ: ${event.formattedTime}`,
      [{ text: 'OK' }]
    );
  };

  const loadUserData = async () => {
    try {
      // Check if user is authenticated first
      const isAuthenticated = ApiService.getInstance().isAuthenticated();
      if (!isAuthenticated) {
        console.log('‚ö†Ô∏è User not authenticated, using mock user');
        const mockUser: User = {
          id: '1',
          email: 'ivan@test.com',
          firstName: '–ò–≤–∞–Ω',
          lastName: '–ü–µ—Ç—Ä–æ–≤',
          phoneNumber: '+359888123456',
          role: 'tradesperson',
          businessId: 'business-1',
          isGdprCompliant: true,
        };
        setUser(mockUser);
        return;
      }

      console.log('üîç Dashboard - Calling getCurrentUser...');
      const response = await ApiService.getInstance().getCurrentUser();
      console.log('üîç Dashboard - getCurrentUser response:', response);
      console.log('üîç Dashboard - response.data:', JSON.stringify(response.data, null, 2));
      
      if (response.success && response.data) {
        console.log('‚úÖ User data loaded from backend:', response.data);
        // Handle nested user object (common API pattern)
        const rawData: any = response.data;
        const userData: any = rawData.user || rawData;
        
        console.log('üîç Checking user fields:', {
          firstName: userData.firstName,
          first_name: userData.first_name,
          lastName: userData.lastName,
          last_name: userData.last_name,
          hasUserObject: !!rawData.user
        });
        
        const mappedUser: User = {
          id: userData.id,
          email: userData.email,
          firstName: userData.firstName || userData.first_name || '–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª',
          lastName: userData.lastName || userData.last_name || '',
          phoneNumber: userData.phoneNumber || userData.phone_number || '',
          role: userData.role || 'tradesperson',
          businessId: userData.businessId || userData.business_id,
          isGdprCompliant: userData.isGdprCompliant || userData.is_gdpr_compliant || false,
        };
        console.log('üì± Mapped user data:', mappedUser);
        setUser(mappedUser);
      } else {
        console.log('‚ö†Ô∏è No user data from backend, using mock user. Response:', response);
        const mockUser: User = {
          id: '1',
          email: 'ivan@test.com',
          firstName: '–ò–≤–∞–Ω',
          lastName: '–ü–µ—Ç—Ä–æ–≤',
          phoneNumber: '+359888123456',
          role: 'tradesperson',
          businessId: 'business-1',
          isGdprCompliant: true,
        };
        setUser(mockUser);
        console.log('üì± Using mock user for testing');
      }
    } catch (error) {
      console.error('‚ùå Failed to load user data:', error);
      // Set mock user as fallback
      const mockUser: User = {
        id: '1',
        email: 'ivan@test.com',
        firstName: '–ò–≤–∞–Ω',
        lastName: '–ü–µ—Ç—Ä–æ–≤',
        phoneNumber: '+359888123456',
        role: 'tradesperson',
        businessId: 'business-1',
        isGdprCompliant: true,
      };
      setUser(mockUser);
      console.log('üì± Using mock user as fallback');
    }
  };

  const loadDashboardData = async () => {
    try {
      console.log('üìä Loading dashboard data from backend...');
      
      // Try to get real stats from backend first
      const response = await ApiService.getInstance().getDashboardStats();
      if (response.success && response.data) {
        console.log('‚úÖ Dashboard stats loaded from backend:', response.data);
        setStats(response.data);
        return;
      }
      
      console.log('‚ö†Ô∏è Backend stats not available, using local data');
      
      // Fallback: Get stored missed calls to update stats
      const storedCalls = await callDetectionService.getStoredMissedCalls();
      const todaysCalls = storedCalls.filter(call => {
        const callDate = new Date(call.timestamp);
        const today = new Date();
        return callDate.toDateString() === today.toDateString();
      });

      const updatedStats: DashboardStats = {
        totalCalls: 87 + storedCalls.length,
        missedCalls: 12 + todaysCalls.length,
        responseRate: Math.max(70, 100 - todaysCalls.length * 2),
        avgResponseTime: '2m 15s',
        activeConversations: 5 + Math.floor(todaysCalls.length / 2),
      };
      
      setStats(updatedStats);
      setLastUpdated(new Date());
      console.log('‚úÖ Dashboard data loaded');
    } catch (error) {
      console.error('Failed to load dashboard data:', error);
    }
  };

  const loadRecentActivity = async () => {
    try {
      console.log('üìã Loading recent activity...');
      
      // Get real missed calls from local storage
      const storedCalls = await callDetectionService.getStoredMissedCalls();
      console.log('üìû Found stored calls:', storedCalls.length);
      
      // Convert stored calls to activity items
      const callActivities: ActivityItem[] = storedCalls
        .slice(0, 10) // Show up to 10 recent calls
        .map((call, index) => ({
          id: call.id || `call_${index}`,
          icon: 'üìû',
          title: '–ü—Ä–æ–ø—É—Å–Ω–∞—Ç–æ –æ–±–∞–∂–¥–∞–Ω–µ',
          subtitle: `${call.phoneNumber} ‚Ä¢ ${call.formattedTime}`,
          status: call.aiResponseSent ? 'AI –æ—Ç–≥–æ–≤–æ—Ä –∏–∑–ø—Ä–∞—Ç–µ–Ω' : '–û–±—Ä–∞–±–æ—Ç–≤–∞ —Å–µ',
          timestamp: call.timestamp,
        }));

      // Sort by timestamp (most recent first)
      const allActivities = callActivities
        .sort((a, b) => b.timestamp - a.timestamp);

      console.log('‚úÖ Recent activity loaded:', allActivities.length, 'items');
      setRecentActivity(allActivities);
    } catch (error) {
      console.error('Failed to load recent activity:', error);
    }
  };

  const refreshCallDetectionStatus = async () => {
    try {
      const permissions = await callDetectionService.checkPermissions();
      
      setCallDetectionStatus({
        isInitialized: callDetectionService.isServiceInitialized(),
        isListening: callDetectionService.isServiceListening(),
        hasPermissions: permissions?.hasAllPermissions || false,
        androidVersion: permissions?.androidVersion || 'Unknown',
      });
    } catch (error) {
      console.error('Failed to refresh call detection status:', error);
    }
  };

  const handleRefresh = async () => {
    setIsRefreshing(true);
    console.log('üîÑ Refreshing dashboard...');
    
    try {
      await loadDashboardData();
      await refreshCallDetectionStatus();
      await loadRecentActivity();
      console.log('‚úÖ Dashboard refreshed successfully');
    } catch (error) {
      console.error('‚ùå Error refreshing dashboard:', error);
    }
    
    setIsRefreshing(false);
  };

  const handleStartCallDetection = async () => {
    try {
      console.log('üöÄ Starting call detection...');
      
      // Check current permissions first
      console.log('üîç Checking current permissions...');
      const currentPermissions = await callDetectionService.checkPermissions();
      console.log('üìã Current permissions status:', currentPermissions);
      
      // Request permissions with detailed feedback
      console.log('üîê Requesting permissions...');
      const hasPermissions = await callDetectionService.requestPermissions();
      
      // Refresh status after permission request
      await refreshCallDetectionStatus();
      
      if (!hasPermissions) {
        Alert.alert(
          '–†–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏',
          '–ó–∞ –¥–µ—Ç–µ–∫—Ü–∏—è –Ω–∞ –æ–±–∞–∂–¥–∞–Ω–∏—è —Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∑–∞:\n\n‚Ä¢ –î–æ—Å—Ç—ä–ø –¥–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ—Ç–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n‚Ä¢ –î–æ—Å—Ç—ä–ø –¥–æ —Å–ø–∏—Å—ä–∫–∞ —Å –æ–±–∞–∂–¥–∞–Ω–∏—è\n\n–ú–æ–ª—è –æ—Ç–∏–¥–µ—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ > –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è > ServiceText Pro > –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –≥–∏ –∞–∫—Ç–∏–≤–∏—Ä–∞–π—Ç–µ —Ä—ä—á–Ω–æ.',
          [
            { text: '–û—Ç–∫–∞–∑', style: 'cancel' },
            { 
              text: '–û—Ç–≤–æ—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏', 
              onPress: () => {
                // This would open app settings, but requires additional setup
                Alert.alert('–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏', '–û—Ç–∏–¥–µ—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ > –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è > ServiceText Pro > –†–∞–∑—Ä–µ—à–µ–Ω–∏—è');
              }
            }
          ]
        );
        return;
      }

      console.log('‚úÖ Permissions granted, starting detection...');

      // Start detection
      const success = await callDetectionService.startDetection();
      if (success) {
        Alert.alert(
          '–£—Å–ø–µ—Ö! üéâ', 
          '–î–µ—Ç–µ–∫—Ü–∏—è—Ç–∞ –Ω–∞ –æ–±–∞–∂–¥–∞–Ω–∏—è –µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!\n\n–°–µ–≥–∞ –º–æ–∂–µ—Ç–µ –¥–∞ —Ç–µ—Å—Ç–≤–∞—Ç–µ —Å —Ä–µ–∞–ª–Ω–æ –ø—Ä–æ–ø—É—Å–Ω–∞—Ç–æ –æ–±–∞–∂–¥–∞–Ω–µ.',
          [{ text: 'OK' }]
        );
        await refreshCallDetectionStatus();
      } else {
        Alert.alert(
          '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ', 
          '–ù–µ —É—Å–ø—è—Ö–º–µ –¥–∞ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ –¥–µ—Ç–µ–∫—Ü–∏—è—Ç–∞ –Ω–∞ –æ–±–∞–∂–¥–∞–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –¥–∞–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è—Ç–∞ —Å–∞ –¥–∞–¥–µ–Ω–∏ –ø—Ä–∞–≤–∏–ª–Ω–æ.',
          [{ text: 'OK' }]
        );
      }
    } catch (error) {
      console.error('‚ùå Error starting call detection:', error);
      Alert.alert(
        '–ì—Ä–µ—à–∫–∞', 
        `–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –¥–µ—Ç–µ–∫—Ü–∏—è—Ç–∞:\n\n${error}`,
        [{ text: 'OK' }]
      );
    }
  };

  const handleStopCallDetection = async () => {
    try {
      const success = await callDetectionService.stopDetection();
      if (success) {
        Alert.alert('–£—Å–ø–µ—Ö', '–î–µ—Ç–µ–∫—Ü–∏—è—Ç–∞ –Ω–∞ –æ–±–∞–∂–¥–∞–Ω–∏—è –µ —Å–ø—Ä—è–Ω–∞.');
        await refreshCallDetectionStatus();
      }
    } catch (error) {
      console.error('Error stopping call detection:', error);
    }
  };





  const handleLogoutPress = async () => {
    Alert.alert(
      '–ò–∑–ª–∏–∑–∞–Ω–µ',
      '–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑–ª–µ–∑–µ—Ç–µ –æ—Ç —Å–∏—Å—Ç–µ–º–∞—Ç–∞?',
      [
        { text: '–û—Ç–∫–∞–∑', style: 'cancel' },
        { 
          text: '–ò–∑–ª–∏–∑–∞–Ω–µ', 
          style: 'destructive', 
          onPress: async () => {
            try {
              await callDetectionService.stopDetection();
              await callDetectionService.clearUserData(); // Clear user-specific data
              await ApiService.getInstance().logout();
              // Do NOT clear remembered credentials; users expect them to persist across logouts
              // Notify app to reset auth state if needed
              AuthBus.emit('logout');
            } catch (error) {
              Alert.alert('–ì—Ä–µ—à–∫–∞', '–ü—Ä–æ–±–ª–µ–º –ø—Ä–∏ –∏–∑–ª–∏–∑–∞–Ω–µ –æ—Ç —Å–∏—Å—Ç–µ–º–∞—Ç–∞');
            }
          }
        },
      ]
    );
  };

  const handleChatPress = () => {
    navigation.navigate('Chat');
  };

  if (!user) {
    return (
      <View style={styles.container}>
        <Text style={styles.errorText}>–ì—Ä–µ—à–∫–∞: –ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è</Text>
      </View>
    );
  }

  return (
    <ScrollView
      style={styles.container}
      refreshControl={
        <RefreshControl refreshing={isRefreshing} onRefresh={handleRefresh} />
      }
    >
      {/* Header */}
      <View style={styles.header}>
        <View style={styles.userInfo}>
          <Text style={styles.welcomeText}>–î–æ–±—Ä–µ –¥–æ—à–ª–∏,</Text>
          <Text style={styles.userName}>
            {user ? `${user.firstName} ${user.lastName}` : '–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...'}
          </Text>
          <Text style={styles.userRole}>
            {user ? (user.role === 'tradesperson' ? '–ó–∞–Ω–∞—è—Ç—á–∏—è' : user.role) : '–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...'}
          </Text>
        </View>
        <View style={styles.headerButtons}>
          <TouchableOpacity style={styles.testButton} onPress={testDatabaseConnection}>
            <Text style={styles.testButtonText}>–¢–µ—Å—Ç DB</Text>
          </TouchableOpacity>
          <TouchableOpacity style={styles.logoutButton} onPress={handleLogoutPress}>
            <Text style={styles.logoutButtonText}>–ò–∑–ª–∏–∑–∞–Ω–µ</Text>
          </TouchableOpacity>
        </View>
      </View>

      {/* Stats Cards */}
      <View style={styles.statsContainer}>
        <View style={styles.statsRow}>
          <View style={[styles.statCard, styles.primaryCard]}>
            <Text style={styles.statNumber}>{stats.totalCalls}</Text>
            <Text style={styles.statLabel}>–û–±—â–æ –æ–±–∞–∂–¥–∞–Ω–∏—è</Text>
          </View>
          <View style={[styles.statCard, styles.warningCard]}>
            <Text style={styles.statNumber}>{stats.missedCalls}</Text>
            <Text style={styles.statLabel}>–ü—Ä–æ–ø—É—Å–Ω–∞—Ç–∏</Text>
          </View>
        </View>
        
        <View style={styles.statsRow}>
          <View style={[styles.statCard, styles.successCard]}>
            <Text style={styles.statNumber}>{stats.responseRate}%</Text>
            <Text style={styles.statLabel}>–û—Ç–≥–æ–≤–æ—Ä–µ–Ω–∏</Text>
          </View>
          <View style={[styles.statCard, styles.infoCard]}>
            <Text style={styles.statNumber}>{stats.avgResponseTime}</Text>
            <Text style={styles.statLabel}>–°—Ä. –≤—Ä–µ–º–µ –æ—Ç–≥–æ–≤–æ—Ä</Text>
          </View>
        </View>

        <View style={[styles.statCard, styles.fullWidth, styles.accentCard]}>
          <Text style={styles.statNumber}>{stats.activeConversations}</Text>
          <Text style={styles.statLabel}>–ê–∫—Ç–∏–≤–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏</Text>
        </View>
      </View>

      {/* Call Detection Status */}
      <View style={styles.statusContainer}>
        <Text style={styles.sectionTitle}>–î–µ—Ç–µ–∫—Ü–∏—è –Ω–∞ –æ–±–∞–∂–¥–∞–Ω–∏—è</Text>
        
        <View style={styles.statusCard}>
          <View style={styles.statusRow}>
            <Text style={styles.statusLabel}>–°—Ç–∞—Ç—É—Å:</Text>
            <View style={[
              styles.statusIndicator, 
              callDetectionStatus.isListening ? styles.statusActive : styles.statusInactive
            ]}>
              <Text style={styles.statusText}>
                {callDetectionStatus.isListening ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}
              </Text>
            </View>
          </View>

          <View style={styles.statusRow}>
            <Text style={styles.statusLabel}>–†–∞–∑—Ä–µ—à–µ–Ω–∏—è:</Text>
            <View style={[
              styles.statusIndicator,
              callDetectionStatus.hasPermissions ? styles.statusActive : styles.statusInactive
            ]}>
              <Text style={styles.statusText}>
                {callDetectionStatus.hasPermissions ? '–î–∞–¥–µ–Ω–∏' : '–ù—É–∂–Ω–∏'}
              </Text>
            </View>
          </View>



          <View style={styles.buttonRow}>
            {!callDetectionStatus.isListening ? (
              <TouchableOpacity style={styles.startButton} onPress={handleStartCallDetection}>
                <Text style={styles.buttonText}>–°—Ç–∞—Ä—Ç–∏—Ä–∞–π –¥–µ—Ç–µ–∫—Ü–∏—è</Text>
              </TouchableOpacity>
            ) : (
              <TouchableOpacity style={styles.stopButton} onPress={handleStopCallDetection}>
                <Text style={styles.buttonText}>–°–ø—Ä–∏ –¥–µ—Ç–µ–∫—Ü–∏—è</Text>
              </TouchableOpacity>
            )}


          </View>
        </View>
      </View>

      {/* Quick Actions */}
      <View style={styles.actionsContainer}>
        <Text style={styles.sectionTitle}>–ë—ä—Ä–∑–∏ –¥–µ–π—Å—Ç–≤–∏—è</Text>
        
        <TouchableOpacity style={styles.actionButton} onPress={handleChatPress}>
          <Text style={styles.actionIcon}>üí¨</Text>
          <View style={styles.actionContent}>
            <Text style={styles.actionTitle}>–ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–∏</Text>
            <Text style={styles.actionSubtitle}>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏</Text>
          </View>
          <Text style={styles.actionArrow}>‚Ä∫</Text>
        </TouchableOpacity>

        <TouchableOpacity 
          style={styles.actionButton} 
          onPress={() => Alert.alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏', '–§—É–Ω–∫—Ü–∏—è—Ç–∞ —â–µ –±—ä–¥–µ –¥–æ–±–∞–≤–µ–Ω–∞ —Å–∫–æ—Ä–æ')}
        >
          <Text style={styles.actionIcon}>üì±</Text>
          <View style={styles.actionContent}>
            <Text style={styles.actionTitle}>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞ —Å—ä–æ–±—â–µ–Ω–∏—è</Text>
            <Text style={styles.actionSubtitle}>WhatsApp, Viber, Telegram</Text>
          </View>
          <Text style={styles.actionArrow}>‚Ä∫</Text>
        </TouchableOpacity>

        <TouchableOpacity 
          style={styles.actionButton} 
          onPress={() => navigation.navigate('Settings', { screen: 'Consent' })}
        >
          <Text style={styles.actionIcon}>üîí</Text>
          <View style={styles.actionContent}>
            <Text style={styles.actionTitle}>GDPR & –ü–æ–≤–µ—Ä–∏—Ç–µ–ª–Ω–æ—Å—Ç</Text>
            <Text style={styles.actionSubtitle}>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ</Text>
          </View>
          <Text style={styles.actionArrow}>‚Ä∫</Text>
        </TouchableOpacity>
      </View>

      {/* Recent Activity */}
      <View style={styles.activityContainer}>
        <Text style={styles.sectionTitle}>–ü–æ—Å–ª–µ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç</Text>
        
        {recentActivity.length > 0 ? (
          recentActivity.map((activity) => (
            <View key={activity.id} style={styles.activityItem}>
              <Text style={styles.activityIcon}>{activity.icon}</Text>
              <View style={styles.activityContent}>
                <Text style={styles.activityTitle}>{activity.title}</Text>
                <Text style={styles.activitySubtitle}>{activity.subtitle}</Text>
              </View>
              <Text style={[
                styles.activityStatus,
                activity.status === '–ó–∞–≤—ä—Ä—à–µ–Ω' ? styles.completedStatus : 
                activity.status === '–ê–∫—Ç–∏–≤–µ–Ω' ? styles.activeStatus : styles.processingStatus
              ]}>
                {activity.status}
              </Text>
            </View>
          ))
        ) : (
          <View style={styles.activityItem}>
            <Text style={styles.activityIcon}>‚ÑπÔ∏è</Text>
            <View style={styles.activityContent}>
              <Text style={styles.activityTitle}>–ù—è–º–∞ –ø–æ—Å–ª–µ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç</Text>
              <Text style={styles.activitySubtitle}>–°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –¥–µ—Ç–µ–∫—Ü–∏—è—Ç–∞ –∑–∞ –¥–∞ –≤–∏–¥–∏—Ç–µ –æ–±–∞–∂–¥–∞–Ω–∏—è</Text>
            </View>
          </View>
        )}
      </View>

      {/* Footer */}
      <View style={styles.footer}>
        <Text style={styles.footerText}>
          –ü–æ—Å–ª–µ–¥–Ω–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è: {lastUpdated.toLocaleTimeString('bg-BG')}
        </Text>
      </View>
    </ScrollView>
  );
};

const { width } = Dimensions.get('window');
const cardWidth = (width - 60) / 2;

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: theme.colors.background.primary,
  },
  header: {
    backgroundColor: theme.colors.primary.solid,
    padding: theme.spacing.lg,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    ...theme.shadows.md,
  },
  userInfo: {
    flex: 1,
  },
  welcomeText: {
    color: theme.colors.text.inverse,
    fontSize: theme.typography.body.fontSize,
    opacity: 0.9,
  },
  userName: {
    color: theme.colors.text.inverse,
    fontSize: theme.typography.h2.fontSize,
    fontWeight: theme.typography.h2.fontWeight,
    marginTop: theme.spacing.xs,
  },
  userRole: {
    color: theme.colors.text.inverse,
    fontSize: theme.typography.bodySmall.fontSize,
    opacity: 0.8,
    marginTop: theme.spacing.xs,
  },
  headerButtons: {
    flexDirection: 'row',
    gap: 8,
  },
  testButton: {
    backgroundColor: theme.colors.success.solid,
    paddingHorizontal: theme.spacing.md,
    paddingVertical: theme.spacing.sm,
    borderRadius: theme.borderRadius.xl,
  },
  testButtonText: {
    color: theme.colors.text.inverse,
    fontSize: theme.typography.bodySmall.fontSize,
    fontWeight: '600',
  },
  logoutButton: {
    backgroundColor: 'rgba(255,255,255,0.2)',
    paddingHorizontal: theme.spacing.md,
    paddingVertical: theme.spacing.sm,
    borderRadius: theme.borderRadius.xl,
  },
  logoutButtonText: {
    color: theme.colors.text.inverse,
    fontSize: theme.typography.bodySmall.fontSize,
    fontWeight: '600',
  },
  statsContainer: {
    padding: theme.spacing.lg,
  },
  statsRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: theme.spacing.md,
  },
  statCard: {
    backgroundColor: theme.colors.background.secondary,
    borderRadius: theme.borderRadius.lg,
    padding: theme.spacing.lg,
    alignItems: 'center',
    ...theme.shadows.md,
    width: cardWidth,
  },
  fullWidth: {
    width: '100%',
  },
  primaryCard: {
    borderLeftWidth: 4,
    borderLeftColor: theme.colors.primary.solid,
  },
  warningCard: {
    borderLeftWidth: 4,
    borderLeftColor: theme.colors.warning.solid,
  },
  successCard: {
    borderLeftWidth: 4,
    borderLeftColor: theme.colors.success.solid,
  },
  infoCard: {
    borderLeftWidth: 4,
    borderLeftColor: theme.colors.status.info,
  },
  accentCard: {
    borderLeftWidth: 4,
    borderLeftColor: theme.colors.primary.solid,
  },
  statNumber: {
    fontSize: theme.typography.h1.fontSize,
    fontWeight: theme.typography.h1.fontWeight,
    color: theme.colors.text.primary,
    marginBottom: theme.spacing.xs,
  },
  statLabel: {
    fontSize: theme.typography.bodySmall.fontSize,
    color: theme.colors.text.secondary,
    textAlign: 'center',
  },
  statusContainer: {
    padding: theme.spacing.lg,
    paddingTop: 0,
  },
  sectionTitle: {
    fontSize: theme.typography.h4.fontSize,
    fontWeight: theme.typography.h4.fontWeight,
    color: theme.colors.text.primary,
    marginBottom: theme.spacing.md,
  },
  statusCard: {
    backgroundColor: theme.colors.background.secondary,
    borderRadius: theme.borderRadius.lg,
    padding: theme.spacing.md,
    ...theme.shadows.md,
  },
  statusRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: theme.spacing.sm,
  },
  statusLabel: {
    fontSize: theme.typography.bodySmall.fontSize,
    color: theme.colors.text.secondary,
    flex: 1,
  },
  statusIndicator: {
    paddingHorizontal: theme.spacing.sm,
    paddingVertical: theme.spacing.xs,
    borderRadius: theme.borderRadius.xl,
  },
  statusActive: {
    backgroundColor: theme.colors.success.solid,
  },
  statusInactive: {
    backgroundColor: theme.colors.danger.solid,
  },
  statusText: {
    fontSize: theme.typography.caption.fontSize,
    color: theme.colors.text.inverse,
    fontWeight: '600',
  },
  statusValue: {
    fontSize: 14,
    color: '#333',
    fontWeight: '500',
  },
  buttonRow: {
    flexDirection: 'row',
    marginTop: 12,
    gap: 8,
  },
  startButton: {
    flex: 1,
    backgroundColor: theme.colors.success.solid,
    paddingVertical: theme.spacing.sm,
    paddingHorizontal: theme.spacing.md,
    borderRadius: theme.borderRadius.md,
    alignItems: 'center',
  },
  stopButton: {
    flex: 1,
    backgroundColor: theme.colors.danger.solid,
    paddingVertical: theme.spacing.sm,
    paddingHorizontal: theme.spacing.md,
    borderRadius: theme.borderRadius.md,
    alignItems: 'center',
  },
  buttonText: {
    color: theme.colors.text.inverse,
    fontSize: theme.typography.bodySmall.fontSize,
    fontWeight: '600',
  },
  actionsContainer: {
    padding: theme.spacing.lg,
    paddingTop: 0,
  },
  actionButton: {
    backgroundColor: theme.colors.background.secondary,
    borderRadius: theme.borderRadius.lg,
    padding: theme.spacing.md,
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: theme.spacing.sm,
    ...theme.shadows.md,
  },
  actionIcon: {
    fontSize: 24,
    marginRight: 16,
  },
  actionContent: {
    flex: 1,
  },
  actionTitle: {
    fontSize: theme.typography.body.fontSize,
    fontWeight: '600',
    color: theme.colors.text.primary,
    marginBottom: theme.spacing.xs,
  },
  actionSubtitle: {
    fontSize: theme.typography.bodySmall.fontSize,
    color: theme.colors.text.secondary,
  },
  actionArrow: {
    fontSize: theme.typography.h3.fontSize,
    color: theme.colors.text.tertiary,
  },
  activityContainer: {
    padding: theme.spacing.lg,
    paddingTop: 0,
  },
  activityItem: {
    backgroundColor: theme.colors.background.secondary,
    borderRadius: theme.borderRadius.lg,
    padding: theme.spacing.md,
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: theme.spacing.sm,
    ...theme.shadows.md,
  },
  activityIcon: {
    fontSize: 24,
    marginRight: 16,
  },
  activityContent: {
    flex: 1,
  },
  activityTitle: {
    fontSize: theme.typography.body.fontSize,
    fontWeight: '600',
    color: theme.colors.text.primary,
    marginBottom: theme.spacing.xs,
  },
  activitySubtitle: {
    fontSize: theme.typography.bodySmall.fontSize,
    color: theme.colors.text.secondary,
  },
  activityStatus: {
    fontSize: theme.typography.bodySmall.fontSize,
    fontWeight: 'bold',
    marginLeft: theme.spacing.sm,
  },
  activeStatus: {
    color: theme.colors.success.solid,
  },
  completedStatus: {
    color: theme.colors.text.tertiary,
  },
  processingStatus: {
    color: theme.colors.warning.solid,
  },
  footer: {
    padding: theme.spacing.lg,
    alignItems: 'center',
  },
  footerText: {
    fontSize: theme.typography.caption.fontSize,
    color: theme.colors.text.tertiary,
  },
  errorText: {
    fontSize: theme.typography.body.fontSize,
    color: theme.colors.danger.solid,
    textAlign: 'center',
    margin: theme.spacing.lg,
  },
});

export default ModernDashboardScreen;
