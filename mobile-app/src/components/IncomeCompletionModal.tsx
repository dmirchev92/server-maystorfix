import React, { useState } from 'react';
import {
  Modal,
  View,
  Text,
  TextInput,
  TouchableOpacity,
  ScrollView,
  StyleSheet,
  Switch,
  Alert,
} from 'react-native';
import theme from '../styles/theme';

interface IncomeCompletionModalProps {
  visible: boolean;
  caseTitle: string;
  onClose: () => void;
  onComplete: (data: {
    completionNotes: string;
    income?: {
      amount: number;
      paymentMethod?: string;
      notes?: string;
    };
  }) => void;
}

export default function IncomeCompletionModal({
  visible,
  caseTitle,
  onClose,
  onComplete,
}: IncomeCompletionModalProps) {
  const [completionNotes, setCompletionNotes] = useState('');
  const [includeIncome, setIncludeIncome] = useState(false);
  const [amount, setAmount] = useState('');
  const [paymentMethod, setPaymentMethod] = useState('');
  const [incomeNotes, setIncomeNotes] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async () => {
    setIsSubmitting(true);

    try {
      const data: any = {
        completionNotes,
      };

      if (includeIncome && amount && parseFloat(amount) > 0) {
        data.income = {
          amount: parseFloat(amount),
          paymentMethod: paymentMethod || undefined,
          notes: incomeNotes || undefined,
        };
      }

      await onComplete(data);

      // Reset form
      setCompletionNotes('');
      setIncludeIncome(false);
      setAmount('');
      setPaymentMethod('');
      setIncomeNotes('');
    } catch (error) {
      console.error('Error completing case:', error);
      Alert.alert('–ì—Ä–µ—à–∫–∞', '–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–≤—ä—Ä—à–≤–∞–Ω–µ—Ç–æ –Ω–∞ –∑–∞—è–≤–∫–∞—Ç–∞');
    } finally {
      setIsSubmitting(false);
    }
  };

  const paymentMethods = [
    { label: '–ò–∑–±–µ—Ä–µ—Ç–µ –º–µ—Ç–æ–¥', value: '' },
    { label: 'üíµ –ö–µ—à', value: 'cash' },
    { label: 'üí≥ –ö–∞—Ä—Ç–æ–≤–æ –ø–ª–∞—â–∞–Ω–µ', value: 'card' },
    { label: 'üè¶ –ë–∞–Ω–∫–æ–≤ –ø—ä—Ç', value: 'bank_transfer' },
    { label: 'üåê Revolut', value: 'online' },
    { label: 'üìù –î—Ä—É–≥–æ', value: 'other' },
  ];

  return (
    <Modal
      visible={visible}
      animationType="slide"
      transparent={true}
      onRequestClose={onClose}
    >
      <View style={styles.modalOverlay}>
        <View style={styles.modalContainer}>
          {/* Header */}
          <View style={styles.header}>
            <Text style={styles.headerTitle}>üèÅ –ó–∞–≤—ä—Ä—à–≤–∞–Ω–µ –Ω–∞ –∑–∞—è–≤–∫–∞</Text>
            <Text style={styles.headerSubtitle}>{caseTitle}</Text>
          </View>

          <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>
            {/* Completion Notes */}
            <View style={styles.section}>
              <Text style={styles.label}>–ë–µ–ª–µ–∂–∫–∏ –∑–∞ –∑–∞–≤—ä—Ä—à–≤–∞–Ω–µ</Text>
              <TextInput
                style={styles.textArea}
                value={completionNotes}
                onChangeText={setCompletionNotes}
                placeholder="–û–ø–∏—à–µ—Ç–µ –∫–∞–∫–≤–æ –µ –Ω–∞–ø—Ä–∞–≤–µ–Ω–æ..."
                placeholderTextColor={theme.colors.text.tertiary}
                multiline
                numberOfLines={3}
              />
            </View>

            {/* Income Tracking Toggle */}
            <View style={styles.incomeToggleContainer}>
              <View style={styles.incomeToggleContent}>
                <View style={styles.incomeToggleTextContainer}>
                  <Text style={styles.incomeToggleTitle}>
                    üí∞ –î–æ–±–∞–≤–∏ –ø—Ä–∏—Ö–æ–¥ –æ—Ç —Ç–∞–∑–∏ –∑–∞—è–≤–∫–∞
                  </Text>
                  <Text style={styles.incomeToggleSubtitle}>
                    –ü—Ä–æ—Å–ª–µ–¥—è–≤–∞–π—Ç–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ —Å–∏ –∑–∞ –ø–æ-–¥–æ–±—Ä–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –±–∏–∑–Ω–µ—Å–∞
                  </Text>
                </View>
                <Switch
                  value={includeIncome}
                  onValueChange={setIncludeIncome}
                  trackColor={{ false: theme.colors.gray[300], true: theme.colors.success.solid }}
                  thumbColor={includeIncome ? theme.colors.success.solid : theme.colors.gray[400]}
                />
              </View>
            </View>

            {/* Income Details */}
            {includeIncome && (
              <View style={styles.incomeDetailsContainer}>
                {/* Amount */}
                <View style={styles.section}>
                  <Text style={styles.label}>
                    –°—É–º–∞ <Text style={styles.required}>*</Text>
                  </Text>
                  <View style={styles.amountInputContainer}>
                    <TextInput
                      style={styles.amountInput}
                      value={amount}
                      onChangeText={setAmount}
                      placeholder="0.00"
                      placeholderTextColor={theme.colors.text.tertiary}
                      keyboardType="decimal-pad"
                    />
                    <Text style={styles.currency}>BGN</Text>
                  </View>
                </View>

                {/* Payment Method */}
                <View style={styles.section}>
                  <Text style={styles.label}>–ú–µ—Ç–æ–¥ –Ω–∞ –ø–ª–∞—â–∞–Ω–µ</Text>
                  <View style={styles.pickerContainer}>
                    {paymentMethods.map((method) => (
                      <TouchableOpacity
                        key={method.value}
                        style={[
                          styles.paymentMethodButton,
                          paymentMethod === method.value && styles.paymentMethodButtonActive,
                        ]}
                        onPress={() => setPaymentMethod(method.value)}
                      >
                        <Text
                          style={[
                            styles.paymentMethodText,
                            paymentMethod === method.value && styles.paymentMethodTextActive,
                          ]}
                        >
                          {method.label}
                        </Text>
                      </TouchableOpacity>
                    ))}
                  </View>
                </View>

                {/* Income Notes */}
                <View style={styles.section}>
                  <Text style={styles.label}>–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –±–µ–ª–µ–∂–∫–∏</Text>
                  <TextInput
                    style={styles.textArea}
                    value={incomeNotes}
                    onChangeText={setIncomeNotes}
                    placeholder="–ù–∞–ø—Ä. —á–∞—Å—Ç–∏—á–Ω–æ –ø–ª–∞—â–∞–Ω–µ, –±–æ–Ω—É—Å –∏ —Ç.–Ω..."
                    placeholderTextColor={theme.colors.text.tertiary}
                    multiline
                    numberOfLines={2}
                  />
                </View>
              </View>
            )}

            {/* Info Box */}
            <View style={styles.infoBox}>
              <Text style={styles.infoText}>
                <Text style={styles.infoBold}>üí° –°—ä–≤–µ—Ç:</Text> –î–æ–±–∞–≤—è–Ω–µ—Ç–æ –Ω–∞ –ø—Ä–∏—Ö–æ–¥ –≤–∏ –ø–æ–º–∞–≥–∞ –¥–∞
                –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞—Ç–µ –º–µ—Å–µ—á–Ω–∏—Ç–µ —Å–∏ –ø—Ä–∏—Ö–æ–¥–∏ –∏ –¥–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞—Ç–µ –±–∏–∑–Ω–µ—Å–∞ —Å–∏ –ø–æ-–¥–æ–±—Ä–µ.
              </Text>
            </View>
          </ScrollView>

          {/* Action Buttons */}
          <View style={styles.buttonContainer}>
            <TouchableOpacity
              style={[styles.button, styles.cancelButton]}
              onPress={onClose}
              disabled={isSubmitting}
            >
              <Text style={styles.cancelButtonText}>–û—Ç–∫–∞–∑</Text>
            </TouchableOpacity>
            <TouchableOpacity
              style={[
                styles.button,
                styles.submitButton,
                (isSubmitting || (includeIncome && (!amount || parseFloat(amount) <= 0))) &&
                  styles.submitButtonDisabled,
              ]}
              onPress={handleSubmit}
              disabled={isSubmitting || (includeIncome && (!amount || parseFloat(amount) <= 0))}
            >
              <Text style={styles.submitButtonText}>
                {isSubmitting ? '‚è≥ –ó–∞–≤—ä—Ä—à–≤–∞–Ω–µ...' : '‚úÖ –ó–∞–≤—ä—Ä—à–∏ –∑–∞—è–≤–∫–∞—Ç–∞'}
              </Text>
            </TouchableOpacity>
          </View>
        </View>
      </View>
    </Modal>
  );
}

const styles = StyleSheet.create({
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: theme.spacing.md,
  },
  modalContainer: {
    backgroundColor: theme.colors.background.primary,
    borderRadius: theme.borderRadius.xl,
    width: '100%',
    maxHeight: '90%',
    ...theme.shadows.lg,
  },
  header: {
    backgroundColor: theme.colors.success.solid,
    padding: theme.spacing.lg,
    borderTopLeftRadius: theme.borderRadius.xl,
    borderTopRightRadius: theme.borderRadius.xl,
  },
  headerTitle: {
    fontSize: theme.typography.h2.fontSize,
    fontWeight: theme.typography.h2.fontWeight,
    color: theme.colors.text.inverse,
  },
  headerSubtitle: {
    fontSize: theme.fontSize.sm,
    color: theme.colors.text.inverse,
    marginTop: theme.spacing.xs,
    opacity: 0.9,
  },
  scrollView: {
    padding: theme.spacing.lg,
  },
  section: {
    marginBottom: theme.spacing.lg,
  },
  label: {
    fontSize: theme.fontSize.sm,
    fontWeight: theme.fontWeight.medium,
    color: theme.colors.text.primary,
    marginBottom: theme.spacing.sm,
  },
  required: {
    color: theme.colors.danger.solid,
  },
  textArea: {
    borderWidth: 1,
    borderColor: theme.colors.border.light,
    borderRadius: theme.borderRadius.md,
    padding: theme.spacing.md,
    fontSize: theme.fontSize.md,
    color: theme.colors.text.primary,
    minHeight: 80,
    textAlignVertical: 'top',
  },
  incomeToggleContainer: {
    backgroundColor: '#E3F2FD',
    borderWidth: 1,
    borderColor: '#2196F3',
    borderRadius: theme.borderRadius.md,
    padding: theme.spacing.md,
    marginBottom: theme.spacing.lg,
  },
  incomeToggleContent: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  incomeToggleTextContainer: {
    flex: 1,
    marginRight: theme.spacing.md,
  },
  incomeToggleTitle: {
    fontSize: theme.fontSize.sm,
    fontWeight: theme.fontWeight.medium,
    color: theme.colors.text.primary,
  },
  incomeToggleSubtitle: {
    fontSize: theme.fontSize.xs,
    color: theme.colors.text.secondary,
    marginTop: theme.spacing.xs,
  },
  incomeDetailsContainer: {
    borderLeftWidth: 4,
    borderLeftColor: theme.colors.success.solid,
    paddingLeft: theme.spacing.lg,
    marginBottom: theme.spacing.lg,
  },
  amountInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: theme.colors.border.light,
    borderRadius: theme.borderRadius.md,
    paddingHorizontal: theme.spacing.md,
  },
  amountInput: {
    flex: 1,
    fontSize: theme.fontSize.md,
    color: theme.colors.text.primary,
    paddingVertical: theme.spacing.sm,
  },
  currency: {
    fontSize: theme.fontSize.md,
    fontWeight: theme.fontWeight.medium,
    color: theme.colors.text.secondary,
  },
  pickerContainer: {
    gap: theme.spacing.sm,
  },
  paymentMethodButton: {
    borderWidth: 1,
    borderColor: theme.colors.border.light,
    borderRadius: theme.borderRadius.md,
    padding: theme.spacing.md,
    backgroundColor: theme.colors.background.secondary,
  },
  paymentMethodButtonActive: {
    borderColor: theme.colors.success.solid,
    backgroundColor: '#E8F5E9',
  },
  paymentMethodText: {
    fontSize: theme.fontSize.md,
    color: theme.colors.text.primary,
  },
  paymentMethodTextActive: {
    color: theme.colors.success.solid,
    fontWeight: theme.fontWeight.semibold,
  },
  infoBox: {
    backgroundColor: '#FFF9C4',
    borderWidth: 1,
    borderColor: '#FBC02D',
    borderRadius: theme.borderRadius.md,
    padding: theme.spacing.md,
    marginBottom: theme.spacing.lg,
  },
  infoText: {
    fontSize: theme.fontSize.sm,
    color: '#F57F17',
  },
  infoBold: {
    fontWeight: theme.fontWeight.bold,
  },
  buttonContainer: {
    flexDirection: 'row',
    gap: theme.spacing.md,
    padding: theme.spacing.lg,
    borderTopWidth: 1,
    borderTopColor: theme.colors.border.light,
  },
  button: {
    flex: 1,
    paddingVertical: theme.spacing.md,
    borderRadius: theme.borderRadius.md,
    alignItems: 'center',
  },
  cancelButton: {
    borderWidth: 1,
    borderColor: theme.colors.border.light,
    backgroundColor: theme.colors.background.secondary,
  },
  cancelButtonText: {
    fontSize: theme.fontSize.md,
    color: theme.colors.text.primary,
    fontWeight: theme.fontWeight.medium,
  },
  submitButton: {
    backgroundColor: theme.colors.success.solid,
  },
  submitButtonDisabled: {
    opacity: 0.5,
  },
  submitButtonText: {
    fontSize: theme.fontSize.md,
    color: theme.colors.text.inverse,
    fontWeight: theme.fontWeight.semibold,
  },
});
