"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[396],{1396:function(e,t,s){s.d(t,{default:function(){return c}});var r=s(7437),l=s(2265),n=s(9376),i=s(4362),o=s(7829),a=s(5090);function d(){let{user:e,isAuthenticated:t}=(0,i.a)(),{conversations:s,activeConversationId:d,messages:c,loading:x,connected:u,setActiveConversation:h,loadConversations:m,loadMessages:p,sendMessage:g,markAsRead:f}=(0,o.R)(),[j,v]=(0,l.useState)(!1),[b,N]=(0,l.useState)(!1),[w,k]=(0,l.useState)(""),y=(0,n.usePathname)();(0,l.useEffect)(()=>{j&&t&&m()},[j,t,m]),(0,l.useEffect)(()=>{d&&(p(d),f(d),setTimeout(()=>{let e=document.querySelector(".chat-messages-container");e&&(e.scrollTop=e.scrollHeight)},100))},[d,p,f]);let C=s.reduce((e,t)=>e+(t.unreadCount||0),0),M=s.find(e=>e.id===d),L=d&&c[d]||[];(0,l.useEffect)(()=>{L.length>0&&setTimeout(()=>{let e=document.querySelector(".chat-messages-container");e&&(e.scrollTop=e.scrollHeight)},100)},[L.length]);let S=async()=>{w.trim()&&d&&(await g(d,w.trim()),k(""))},z=e=>{h(e)},B=e=>{let t=new Date(e),s=new Date().getTime()-t.getTime(),r=Math.floor(s/6e4),l=Math.floor(s/36e5),n=Math.floor(s/864e5);return r<1?"Сега":r<60?"".concat(r," мин"):l<24?"".concat(l," ч"):n<7?"".concat(n," д"):t.toLocaleDateString("bg-BG",{day:"numeric",month:"short"})};return(null==y?void 0:y.startsWith("/auth/"))?null:t&&e?(0,r.jsxs)(r.Fragment,{children:[!j&&(0,r.jsxs)("button",{onClick:()=>v(!0),className:"fixed bottom-6 right-6 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white p-4 rounded-full shadow-lg transition-all duration-200 z-[9999] border-4 border-white","aria-label":"Отвори чат",children:[(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),C>0&&(0,r.jsx)("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold",children:C>99?"99+":C}),u&&(0,r.jsx)("div",{className:"absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"})]}),j&&(0,r.jsxs)("div",{className:"fixed bottom-6 right-6 bg-white rounded-lg shadow-2xl border border-gray-200 z-[9999] transition-all duration-200 flex flex-col ".concat(b?"w-80 h-14":"w-96 h-[600px]"),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-t-lg",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[M&&!b&&(0,r.jsx)("button",{onClick:()=>{h(null)},className:"hover:bg-white/10 p-1 rounded transition",title:"Назад",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,r.jsx)("div",{className:"w-2 h-2 rounded-full ".concat(u?"bg-green-400":"bg-gray-400")}),(0,r.jsx)("div",{className:"flex-1 min-w-0",children:M?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("span",{className:"font-medium text-sm truncate block",children:(null==e?void 0:e.role)==="customer"?M.providerBusinessName||M.providerName||"Майстор":M.customerName||"Клиент"}),(null==e?void 0:e.role)==="customer"&&M.providerServiceCategory&&(0,r.jsx)("span",{className:"text-xs text-indigo-200 truncate block",children:M.providerServiceCategory})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("span",{className:"font-medium text-sm truncate block",children:"Съобщения"}),C>0&&(0,r.jsxs)("span",{className:"text-xs text-indigo-200",children:[C," непрочетени"]})]})})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)("button",{onClick:()=>N(!b),className:"hover:bg-white/10 p-1 rounded transition",title:b?"Разшири":"Минимизирай",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:b?(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"}):(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})}),(0,r.jsx)("button",{onClick:()=>v(!1),className:"hover:bg-white/10 p-1 rounded transition",title:"Затвори",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),!b&&(0,r.jsx)("div",{className:"flex-1 flex flex-col overflow-hidden",children:M?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"chat-messages-container flex-1 overflow-y-auto bg-gray-50 p-3 space-y-2",children:x&&0===L.length?(0,r.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,r.jsxs)("div",{className:"text-center text-gray-500",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),(0,r.jsx)("p",{className:"text-sm",children:"Зареждане..."})]})}):0===L.length?(0,r.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,r.jsxs)("div",{className:"text-center text-gray-500",children:[(0,r.jsx)("div",{className:"text-3xl mb-2",children:"\uD83D\uDCAC"}),(0,r.jsx)("p",{className:"text-sm",children:"Няма съобщения"}),(0,r.jsx)("p",{className:"text-xs mt-1",children:"Започнете разговор"})]})}):L.map((e,t)=>{let s=0===t||L[t-1].senderUserId!==e.senderUserId;return(0,r.jsx)(a.Z,{message:e,showSenderName:s},e.id)})}),(0,r.jsx)("div",{className:"border-t p-3 bg-white",children:(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("input",{type:"text",value:w,onChange:e=>k(e.target.value),onKeyPress:e=>"Enter"===e.key&&S(),placeholder:"Напишете съобщение...",className:"flex-1 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500",disabled:x}),(0,r.jsx)("button",{onClick:S,disabled:!w.trim()||x,className:"bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-lg disabled:opacity-50 hover:from-purple-700 hover:to-indigo-700 transition",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})})]}):(0,r.jsx)("div",{className:"flex-1 overflow-y-auto",children:x?(0,r.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,r.jsxs)("div",{className:"text-center text-gray-500",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),(0,r.jsx)("p",{className:"text-sm",children:"Зареждане..."})]})}):0===s.length?(0,r.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,r.jsxs)("div",{className:"text-center text-gray-500 p-4",children:[(0,r.jsx)("div",{className:"text-4xl mb-2",children:"\uD83D\uDCAC"}),(0,r.jsx)("p",{className:"text-sm font-medium",children:"Няма разговори"}),(0,r.jsx)("p",{className:"text-xs mt-1",children:"Започнете нов разговор"})]})}):s.map(t=>{var s;let l=(t.unreadCount||0)>0,n=(null==e?void 0:e.role)==="customer"?t.providerBusinessName||t.providerName||"Майстор":t.customerName||"Клиент",i=n.charAt(0).toUpperCase(),o=(null==e?void 0:e.role)==="customer"&&t.providerServiceCategory;return(0,r.jsxs)("button",{onClick:()=>z(t.id),className:"group w-full p-3.5 rounded-lg border border-transparent text-left relative transition-all\n                            hover:bg-white hover:shadow-sm hover:border-purple-200\n                            ".concat(l?"bg-purple-50/40":"","\n                          "),children:[(0,r.jsx)("div",{className:"absolute left-0 top-0 bottom-0 w-1 rounded-l-lg transition-colors ".concat(l?"bg-purple-500":"bg-transparent"," group-hover:bg-purple-400")}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:"relative flex-shrink-0",children:(0,r.jsx)("div",{className:"w-11 h-11 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center shadow-sm",children:(0,r.jsx)("span",{className:"text-white font-semibold text-sm",children:i})})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,r.jsx)("h3",{className:"font-semibold text-sm truncate ".concat(l?"text-gray-900":"text-gray-800"),children:n}),(0,r.jsxs)("div",{className:"flex items-center gap-2 flex-shrink-0",children:[(0,r.jsx)("span",{className:"text-[11px] text-gray-400",children:B(t.lastMessageAt)}),l&&(0,r.jsx)("span",{className:"inline-flex items-center justify-center min-w-5 h-5 px-1.5 rounded-full bg-purple-600 text-white text-[10px] font-bold",children:t.unreadCount})]})]}),(0,r.jsxs)("div",{className:"mt-1 flex items-center gap-2",children:[o&&(0,r.jsxs)("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full border border-purple-300 text-purple-700 bg-white text-[11px] font-medium flex-shrink-0 group-hover:border-purple-400 group-hover:bg-purple-50",children:[(0,r.jsx)("svg",{className:"w-3 h-3 mr-1",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{d:"M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"})}),t.providerServiceCategory]}),(0,r.jsx)("p",{className:"truncate text-xs ".concat(l?"text-gray-700":"text-gray-500"),children:(null===(s=t.lastMessage)||void 0===s?void 0:s.body)||"Няма съобщения"})]})]})]})]},t.id)})})})]})]}):(0,r.jsxs)("button",{onClick:()=>window.location.href="/auth/login",className:"fixed bottom-6 right-6 bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-full shadow-lg transition-all duration-200 z-[9999]","aria-label":"Влезте за чат",children:[(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),(0,r.jsx)("div",{className:"absolute -top-2 -right-2 bg-blue-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold",children:"!"})]})}function c(){let e=(0,n.usePathname)();return(null==e?void 0:e.startsWith("/auth/"))||"/chat"===e?null:(0,r.jsx)(d,{})}}}]);