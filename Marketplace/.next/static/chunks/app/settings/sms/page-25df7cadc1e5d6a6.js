(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[296],{1371:function(e,t,s){Promise.resolve().then(s.bind(s,7793))},7793:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return d}});var n=s(7437),a=s(2265),l=s(4362),r=s(9376),i=s(757),o=s(6334),c=s(1819);function d(){let{user:e,isAuthenticated:t,isLoading:s}=(0,l.a)(),d=(0,r.useRouter)(),[u,h]=(0,a.useState)(!0),[x,m]=(0,a.useState)(!1),[g,f]=(0,a.useState)({isEnabled:!1,message:"Зает съм, ще върна обаждане след няколко минути.\n\nЗапочнете чат тук:\n[chat_link]\n\n",sentCount:0,filterKnownContacts:!0,processedCalls:0}),[b,p]=(0,a.useState)(""),[D,j]=(0,a.useState)(""),[w,v]=(0,a.useState)({todayCount:0,thisHourCount:0,totalCount:0});(0,a.useEffect)(()=>{if(b&&g.userChatLinks&&(null==e?void 0:e.id)){let t=g.userChatLinks[e.id];t&&t.link?j(b.replace("[chat_link]",t.link)):j(b)}else j(b)},[b,g.userChatLinks,null==e?void 0:e.id]),(0,a.useEffect)(()=>{if(!s){if(!t){d.push("/auth/login");return}if((null==e?void 0:e.role)!=="tradesperson"&&(null==e?void 0:e.role)!=="service_provider"){d.push("/");return}N()}},[t,s,e,d]);let N=async()=>{try{h(!0);let n=await fetch("".concat("https://maystorfix.com/api/v1","/sms/config"),{headers:{Authorization:"Bearer ".concat(localStorage.getItem("auth_token")),"Content-Type":"application/json"}});if(n.ok){var t,s;let a=await n.json();if(console.log("\uD83D\uDD0D SMS Config loaded:",a),console.log("\uD83D\uDD0D User ID:",null==e?void 0:e.id),console.log("\uD83D\uDD0D Config userChatLinks:",null===(s=a.data)||void 0===s?void 0:null===(t=s.config)||void 0===t?void 0:t.userChatLinks),a.success){f(a.data.config),p(a.data.config.message);let t=a.data.config.message;if(console.log("\uD83D\uDD0D Original message:",t),a.data.config.userChatLinks&&(null==e?void 0:e.id)){console.log("\uD83D\uDD0D Looking for user chat link...");let s=a.data.config.userChatLinks[e.id];console.log("\uD83D\uDD0D User link object:",s),s&&s.link?(t=t.replace("[chat_link]",s.link),console.log("✅ Replaced [chat_link] with actual link:",s.link),console.log("✅ Preview text:",t)):(console.log("⚠️ No chat link found for user:",e.id),console.log("⚠️ Available user IDs:",Object.keys(a.data.config.userChatLinks)))}else console.log("⚠️ No userChatLinks in config or no user ID");j(t),v(a.data.stats||{todayCount:0,thisHourCount:0,totalCount:0})}}else console.warn("Failed to load SMS config, using defaults")}catch(e){console.error("Error loading SMS config:",e)}finally{h(!1)}},S=async e=>{try{m(!0);let t=await fetch("".concat("https://maystorfix.com/api/v1","/sms/config"),{method:"PUT",headers:{Authorization:"Bearer ".concat(localStorage.getItem("auth_token")),"Content-Type":"application/json"},body:JSON.stringify(e)});t.ok&&(await t.json()).success?(f(t=>({...t,...e})),alert("SMS настройките са запазени успешно!")):alert("Грешка при запазване на настройките")}catch(e){console.error("Error updating SMS config:",e),alert("Грешка при запазване на настройките")}finally{m(!1)}},k=async()=>{await S({isEnabled:!g.isEnabled})},y=async()=>{if(!b.trim()){alert("Съобщението не може да бъде празно");return}await S({message:b.trim()})},C=async()=>{await S({filterKnownContacts:!g.filterKnownContacts})},M=async()=>{try{m(!0);let l=localStorage.getItem("auth_token");if(console.log("\uD83D\uDD17 Generating new chat link for user:",null==e?void 0:e.id),console.log("\uD83D\uDD17 Auth token available:",!!l),console.log("\uD83D\uDD17 User object:",e),!l){alert("Не сте влезли в системата. Моля влезте отново.");return}let r="".concat("https://maystorfix.com/api/v1","/chat/tokens/regenerate");console.log("\uD83D\uDD17 Making request to:",r);let i=await fetch(r,{method:"POST",headers:{Authorization:"Bearer ".concat(l),"Content-Type":"application/json"}});if(console.log("\uD83D\uDD17 Token generation response:",{status:i.status,statusText:i.statusText,headers:Object.fromEntries(i.headers.entries())}),i.ok){var t,s,n,a;let e=await i.json();if(console.log("\uD83D\uDD17 Token generation result:",e),e.success){let a=null===(t=e.data)||void 0===t?void 0:t.chatUrl;if(console.log("\uD83D\uDD17 Generated chat URL:",a),alert("Нова чат връзка е генерирана успешно!\n\nВръзка: ".concat(a||"Проверете конзолата за детайли","\n\nТокен: ").concat(null===(n=e.data)||void 0===n?void 0:null===(s=n.token)||void 0===s?void 0:s.substring(0,4),"****")),a){let e=b.replace("[chat_link]",a);j(e)}N()}else console.error("\uD83D\uDD17 Token generation failed:",e),alert("Грешка при генериране на нова връзка: "+((null===(a=e.error)||void 0===a?void 0:a.message)||"Неизвестна грешка"))}else{let e=await i.text();console.error("\uD83D\uDD17 Token generation failed:",{status:i.status,statusText:i.statusText,errorText:e}),alert("Грешка при генериране на нова връзка: ".concat(i.status," ").concat(i.statusText,"\n\nДетайли: ").concat(e))}}catch(e){console.error("\uD83D\uDD17 Error generating new link:",e),alert("Грешка при генериране на нова връзка: "+((null==e?void 0:e.message)||"Неизвестна грешка"))}finally{m(!1)}},E=async()=>{if(confirm("Сигурни ли сте, че искате да изчистите историята на SMS? Само НОВИ пропуснати обаждания ще получават SMS след това."))try{m(!0),(await fetch("".concat("https://maystorfix.com/api/v1","/sms/history/clear"),{method:"DELETE",headers:{Authorization:"Bearer ".concat(localStorage.getItem("auth_token")),"Content-Type":"application/json"}})).ok?(alert("Историята на SMS е изчистена успешно!"),N()):alert("Грешка при изчистване на историята")}catch(e){console.error("Error clearing SMS history:",e),alert("Грешка при изчистване на историята")}finally{m(!1)}};return u?(0,n.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-indigo-600 mx-auto"}),(0,n.jsx)("p",{className:"mt-4 text-gray-600",children:"Зареждане на SMS настройки..."})]})}):(0,n.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-indigo-900",children:[(0,n.jsx)(c.Header,{}),(0,n.jsxs)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[(0,n.jsxs)("div",{className:"mb-8",children:[(0,n.jsx)("h1",{className:"text-3xl font-bold text-white",children:"SMS Настройки"}),(0,n.jsx)("p",{className:"mt-2 text-slate-300",children:"Управлявайте автоматичните SMS съобщения за пропуснати обаждания"})]}),(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,n.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,n.jsxs)(i.Zb,{children:[(0,n.jsx)(i.Ol,{children:(0,n.jsxs)(i.ll,{className:"flex items-center",children:[(0,n.jsx)("span",{className:"text-2xl mr-2",children:"\uD83D\uDCF1"}),"SMS Статус"]})}),(0,n.jsx)(i.aY,{children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-medium text-white",children:"Автоматични SMS"}),(0,n.jsx)("p",{className:"text-slate-300",children:g.isEnabled?"Включени - SMS ще се изпращат при пропуснати обаждания":"Изключени - няма да се изпращат SMS"})]}),(0,n.jsx)("button",{onClick:k,disabled:x,className:"relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 ".concat(g.isEnabled?"bg-indigo-600":"bg-gray-200"),children:(0,n.jsx)("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white transition-transform ".concat(g.isEnabled?"translate-x-6":"translate-x-1")})})]})})]}),(0,n.jsxs)(i.Zb,{children:[(0,n.jsx)(i.Ol,{children:(0,n.jsxs)(i.ll,{className:"flex items-center",children:[(0,n.jsx)("span",{className:"text-2xl mr-2",children:"✏️"}),"SMS Шаблон"]})}),(0,n.jsxs)(i.aY,{className:"space-y-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-white mb-2",children:"Съобщение за SMS"}),(0,n.jsx)("textarea",{value:b,onChange:e=>p(e.target.value),className:"w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-slate-400",rows:4,placeholder:"Зает съм, ще върна обаждане след няколко минути.\\n\\nЗапочнете чат тук:\\n[chat_link]\\n\\n"}),(0,n.jsx)("p",{className:"mt-1 text-sm text-slate-400",children:"\uD83D\uDCA1 Използвайте [chat_link] където искате да се появи автоматично обновяващата се чат връзка"})]}),(0,n.jsxs)("div",{className:"bg-indigo-500/10 border-l-4 border-indigo-400/50 p-4 rounded backdrop-blur-sm",children:[(0,n.jsx)("h4",{className:"text-sm font-medium text-indigo-300 mb-2",children:"\uD83D\uDCF1 Преглед на SMS:"}),(0,n.jsx)("p",{className:"text-sm text-indigo-200 whitespace-pre-wrap",children:D||"Зареждане на преглед..."}),(0,n.jsx)("p",{className:"text-xs text-indigo-300 mt-2 italic",children:"Това е съобщението, което клиентите ще получат"})]}),(0,n.jsxs)("div",{className:"flex gap-3",children:[(0,n.jsx)("button",{onClick:y,disabled:x,className:"flex-1 bg-white/20 backdrop-blur-sm text-white hover:bg-white/30 border border-white/30 rounded-md px-4 py-2 font-medium transition-colors disabled:opacity-50",children:x?"Запазване...":"Обнови Шаблон"}),(0,n.jsx)("button",{onClick:M,disabled:x,className:"bg-green-500/20 backdrop-blur-sm border border-green-400/30 text-green-300 hover:bg-green-500/30 rounded-md px-4 py-2 font-medium transition-colors disabled:opacity-50",children:"\uD83D\uDD04 Нова Връзка"})]})]})]}),(0,n.jsxs)(i.Zb,{children:[(0,n.jsx)(i.Ol,{children:(0,n.jsxs)(i.ll,{className:"flex items-center",children:[(0,n.jsx)("span",{className:"text-2xl mr-2",children:"\uD83D\uDC65"}),"Филтриране на Контакти"]})}),(0,n.jsx)(i.aY,{children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-medium text-white",children:"Филтрирай познати контакти"}),(0,n.jsx)("p",{className:"text-slate-300",children:g.filterKnownContacts?"Включено - SMS ще се изпращат само на непознати номера":"Изключено - SMS ще се изпращат на всички номера"})]}),(0,n.jsx)("button",{onClick:C,disabled:x,className:"relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 ".concat(g.filterKnownContacts?"bg-indigo-600":"bg-gray-200"),children:(0,n.jsx)("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white transition-transform ".concat(g.filterKnownContacts?"translate-x-6":"translate-x-1")})})]})})]})]}),(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)(i.Zb,{children:[(0,n.jsx)(i.Ol,{children:(0,n.jsxs)(i.ll,{className:"flex items-center",children:[(0,n.jsx)("span",{className:"text-2xl mr-2",children:"\uD83D\uDCCA"}),"Статистики"]})}),(0,n.jsxs)(i.aY,{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"grid grid-cols-1 gap-4",children:[(0,n.jsxs)("div",{className:"bg-white/10 p-3 rounded-lg border border-white/20",children:[(0,n.jsx)("div",{className:"text-2xl font-bold text-indigo-400",children:g.sentCount}),(0,n.jsx)("div",{className:"text-sm text-slate-300",children:"Общо изпратени SMS"})]}),(0,n.jsxs)("div",{className:"bg-white/10 p-3 rounded-lg border border-white/20",children:[(0,n.jsx)("div",{className:"text-2xl font-bold text-green-400",children:w.todayCount}),(0,n.jsx)("div",{className:"text-sm text-slate-300",children:"Днес"})]}),(0,n.jsxs)("div",{className:"bg-white/10 p-3 rounded-lg border border-white/20",children:[(0,n.jsx)("div",{className:"text-2xl font-bold text-orange-400",children:g.processedCalls}),(0,n.jsx)("div",{className:"text-sm text-slate-300",children:"Обработени обаждания"})]})]}),g.lastSentTime&&(0,n.jsxs)("div",{className:"text-sm text-slate-300",children:[(0,n.jsx)("strong",{children:"Последно SMS:"}),(0,n.jsx)("br",{}),new Date(g.lastSentTime).toLocaleString("bg-BG")]})]})]}),(0,n.jsxs)(i.Zb,{children:[(0,n.jsx)(i.Ol,{children:(0,n.jsxs)(i.ll,{className:"flex items-center",children:[(0,n.jsx)("span",{className:"text-2xl mr-2",children:"\uD83D\uDEE0️"}),"Действия"]})}),(0,n.jsxs)(i.aY,{className:"space-y-3",children:[(0,n.jsx)(o.z,{onClick:E,disabled:x,variant:"outline",className:"w-full bg-red-500/10 border-red-400/30 text-red-300 hover:bg-red-500/20",children:"\uD83D\uDDD1️ Изчисти История"}),(0,n.jsx)("p",{className:"text-xs text-slate-400",children:"Изчистване на историята ще позволи SMS да се изпращат отново на номера, които вече са получавали SMS"})]})]}),(0,n.jsxs)(i.Zb,{children:[(0,n.jsx)(i.Ol,{children:(0,n.jsxs)(i.ll,{className:"flex items-center",children:[(0,n.jsx)("span",{className:"text-2xl mr-2",children:"\uD83D\uDCA1"}),"Помощ"]})}),(0,n.jsxs)(i.aY,{className:"space-y-2 text-sm text-slate-300",children:[(0,n.jsx)("p",{children:"• SMS се изпращат автоматично при пропуснати обаждания"}),(0,n.jsx)("p",{children:"• Всеки номер получава SMS само веднъж на 5 дни"}),(0,n.jsx)("p",{children:"• Чат връзката се обновява автоматично при всяко използване"}),(0,n.jsx)("p",{children:"• Можете да тествате настройките от мобилното приложение"})]})]})]})]})]})]})}},757:function(e,t,s){"use strict";s.d(t,{Ol:function(){return i},Zb:function(){return r},aY:function(){return c},ll:function(){return o}});var n=s(7437),a=s(2265),l=s(3448);let r=a.forwardRef((e,t)=>{let{className:s,variant:a="default",padding:r="md",hover:i=!1,children:o,...c}=e;return(0,n.jsx)("div",{className:(0,l.cn)("\n      rounded-xl transition-all duration-300 ease-in-out\n      ".concat(i?"hover:scale-[1.02] hover:shadow-xl cursor-pointer":"","\n    "),{default:"\n        bg-white/10 backdrop-blur-md border border-white/20 shadow-lg\n        hover:shadow-xl hover:bg-white/15\n      ",elevated:"\n        bg-white/10 backdrop-blur-md shadow-xl hover:shadow-2xl\n        border border-white/20 hover:border-white/30\n      ",glass:"\n        bg-white/10 backdrop-blur-md border border-white/20\n        shadow-lg hover:shadow-xl hover:bg-white/20\n      ",gradient:"\n        bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-md\n        border border-white/20 shadow-lg\n        hover:from-white/15 hover:to-white/10 hover:shadow-xl\n      ",outline:"\n        bg-transparent border-2 border-white/30\n        hover:border-white/50 hover:bg-white/10\n      "}[a],{none:"",sm:"p-4",md:"p-6",lg:"p-8",xl:"p-10"}[r],s),ref:t,...c,children:o})});r.displayName="Card";let i=a.forwardRef((e,t)=>{let{className:s,children:a,...r}=e;return(0,n.jsx)("div",{ref:t,className:(0,l.cn)("flex flex-col space-y-1.5 pb-4",s),...r,children:a})});i.displayName="CardHeader";let o=a.forwardRef((e,t)=>{let{className:s,children:a,...r}=e;return(0,n.jsx)("h3",{ref:t,className:(0,l.cn)("text-lg font-semibold leading-none tracking-tight text-white",s),...r,children:a})});o.displayName="CardTitle",a.forwardRef((e,t)=>{let{className:s,children:a,...r}=e;return(0,n.jsx)("p",{ref:t,className:(0,l.cn)("text-sm text-slate-300",s),...r,children:a})}).displayName="CardDescription";let c=a.forwardRef((e,t)=>{let{className:s,children:a,...r}=e;return(0,n.jsx)("div",{ref:t,className:(0,l.cn)("",s),...r,children:a})});c.displayName="CardContent",a.forwardRef((e,t)=>{let{className:s,children:a,...r}=e;return(0,n.jsx)("div",{ref:t,className:(0,l.cn)("flex items-center pt-4",s),...r,children:a})}).displayName="CardFooter"}},function(e){e.O(0,[301,648,137,924,819,971,117,744],function(){return e(e.s=1371)}),_N_E=e.O()}]);