(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[929],{9341:function(e,s,t){Promise.resolve().then(t.bind(t,6809))},6809:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return p}});var r=t(7437),l=t(2265),n=t(7829),a=t(4362);function i(e){let{conversations:s,activeConversationId:t,onSelectConversation:l,loading:n=!1}=e,{user:i}=(0,a.a)(),c=e=>{let s=new Date(e),t=new Date().getTime()-s.getTime(),r=Math.floor(t/6e4),l=Math.floor(t/36e5),n=Math.floor(t/864e5);return r<1?"Сега":r<60?"".concat(r," мин"):l<24?"".concat(l," ч"):n<7?"".concat(n," д"):s.toLocaleDateString("bg-BG",{day:"numeric",month:"short"})};return n?(0,r.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,r.jsxs)("div",{className:"inline-flex items-center gap-2 text-gray-500",children:[(0,r.jsxs)("svg",{className:"animate-spin h-5 w-5",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),(0,r.jsx)("span",{children:"Зареждане..."})]})}):0===s.length?(0,r.jsx)("div",{className:"flex items-center justify-center h-full text-center p-8",children:(0,r.jsxs)("div",{className:"text-gray-500",children:[(0,r.jsx)("svg",{className:"w-16 h-16 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"})}),(0,r.jsx)("p",{className:"text-lg font-medium",children:"Няма разговори"}),(0,r.jsx)("p",{className:"text-sm mt-1",children:"Започнете нов разговор с доставчик"})]})}):(0,r.jsx)("div",{className:"h-full overflow-y-auto bg-white",children:s.map(e=>{var s;let n=e.id===t,a=(e.unreadCount||0)>0,o=(null==i?void 0:i.role)==="customer"?e.providerBusinessName||e.providerName||"Майстор":e.customerName||"Клиент",d=o.charAt(0).toUpperCase(),x=(null==i?void 0:i.role)==="customer"&&e.providerServiceCategory;return(0,r.jsxs)("button",{onClick:()=>l(e.id),className:"\n              group w-full p-4 rounded-lg border border-transparent text-left relative transition-all\n              hover:bg-white hover:shadow-sm hover:border-purple-200\n              ".concat(n?"bg-gradient-to-r from-purple-100 to-indigo-100":"","\n              ").concat(a&&!n?"bg-purple-50/40":"","\n            "),children:[(0,r.jsx)("div",{className:"absolute left-0 top-0 bottom-0 w-1 rounded-l-lg transition-colors ".concat(n?"bg-purple-600":a?"bg-purple-500":"bg-transparent"," group-hover:bg-purple-400")}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:"relative flex-shrink-0",children:(0,r.jsx)("div",{className:"\n                  w-12 h-12 rounded-full flex items-center justify-center text-white font-bold shadow-md\n                  ".concat(n?"bg-gradient-to-br from-purple-600 to-indigo-700":"bg-gradient-to-br from-purple-500 to-indigo-600","\n                "),children:d})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 min-w-0",children:[(0,r.jsx)("h3",{className:"font-semibold text-sm truncate ".concat(a||n?"text-gray-900":"text-gray-800"),children:o}),x&&(0,r.jsxs)("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full border border-purple-300 text-purple-700 bg-white text-[11px] font-medium flex-shrink-0 group-hover:border-purple-400 group-hover:bg-purple-50",children:[(0,r.jsx)("svg",{className:"w-3 h-3 mr-1",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{d:"M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"})}),e.providerServiceCategory]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2 flex-shrink-0",children:[(0,r.jsx)("span",{className:"text-[11px] text-gray-400",children:c(e.lastMessageAt)}),a&&(0,r.jsx)("span",{className:"inline-flex items-center justify-center min-w-5 h-5 px-1.5 rounded-full bg-purple-600 text-white text-[10px] font-bold",children:e.unreadCount})]})]}),(0,r.jsx)("div",{className:"mt-1 flex items-center justify-between gap-2",children:(0,r.jsx)("p",{className:"text-sm truncate flex-1 ".concat(a?"font-medium text-gray-700":"text-gray-500"),children:(null===(s=e.lastMessage)||void 0===s?void 0:s.body)||"Няма съобщения"})}),e.customerEmail&&(0,r.jsx)("p",{className:"text-xs text-gray-400 mt-1 truncate",children:e.customerEmail})]})]})]},e.id)})})}var c=t(5090);function o(e){let{messages:s,loading:t=!1,onLoadMore:n,hasMore:a=!1}=e,i=(0,l.useRef)(null),o=(0,l.useRef)(null),d=(0,l.useRef)(s.length);return((0,l.useEffect)(()=>{if(s.length>d.current){var e;null===(e=i.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}d.current=s.length},[s]),(0,l.useEffect)(()=>{var e;null===(e=i.current)||void 0===e||e.scrollIntoView({behavior:"auto"})},[]),0!==s.length||t)?(0,r.jsxs)("div",{ref:o,onScroll:()=>{if(!o.current||!n||!a||t)return;let{scrollTop:e}=o.current;0===e&&n()},className:"flex-1 overflow-y-auto bg-gray-50 p-4 space-y-2",children:[a&&(0,r.jsx)("div",{className:"text-center py-2",children:t?(0,r.jsxs)("div",{className:"inline-flex items-center gap-2 text-sm text-gray-500",children:[(0,r.jsxs)("svg",{className:"animate-spin h-4 w-4",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),(0,r.jsx)("span",{children:"Зареждане..."})]}):(0,r.jsx)("button",{onClick:n,className:"text-sm text-purple-600 hover:text-purple-700 font-medium",children:"Зареди по-стари съобщения"})}),s.map((e,t)=>{let l=0===t||s[t-1].senderUserId!==e.senderUserId;return(0,r.jsx)(c.Z,{message:e,showSenderName:l},e.id)}),t&&0===s.length&&(0,r.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,r.jsxs)("div",{className:"inline-flex items-center gap-2 text-gray-500",children:[(0,r.jsxs)("svg",{className:"animate-spin h-5 w-5",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),(0,r.jsx)("span",{children:"Зареждане на съобщения..."})]})}),(0,r.jsx)("div",{ref:i})]}):(0,r.jsx)("div",{className:"flex-1 flex items-center justify-center bg-gray-50",children:(0,r.jsxs)("div",{className:"text-center text-gray-500",children:[(0,r.jsx)("svg",{className:"w-16 h-16 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),(0,r.jsx)("p",{className:"text-lg font-medium",children:"Няма съобщения"}),(0,r.jsx)("p",{className:"text-sm mt-1",children:"Започнете разговор като изпратите съобщение"})]})})}function d(e){let{onSend:s,disabled:t=!1,placeholder:n="Напишете съобщение..."}=e,[a,i]=(0,l.useState)(""),c=(0,l.useRef)(null),o=()=>{let e=a.trim();e&&!t&&(s(e),i(""),c.current&&(c.current.style.height="auto"))};return(0,r.jsxs)("div",{className:"border-t border-gray-200 bg-white p-4",children:[(0,r.jsxs)("div",{className:"flex items-end gap-2",children:[(0,r.jsxs)("div",{className:"flex-1 relative",children:[(0,r.jsx)("textarea",{ref:c,value:a,onChange:e=>{i(e.target.value);let s=e.target;s.style.height="auto",s.style.height=Math.min(s.scrollHeight,150)+"px"},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),o())},placeholder:n,disabled:t,rows:1,className:" w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed text-sm ",style:{maxHeight:"150px"}}),a.length>0&&(0,r.jsxs)("div",{className:"absolute bottom-2 right-2 text-xs text-gray-400",children:[a.length,"/10000"]})]}),(0,r.jsxs)("button",{onClick:o,disabled:t||!a.trim(),className:" px-6 py-3 rounded-lg bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-medium hover:from-purple-700 hover:to-indigo-700 disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed transition-all duration-200 flex items-center gap-2 ",children:[(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})}),(0,r.jsx)("span",{className:"hidden sm:inline",children:"Изпрати"})]})]}),(0,r.jsx)("div",{className:"mt-2 text-xs text-gray-500",children:"Натиснете Enter за изпращане, Shift+Enter за нов ред"})]})}function x(e){let{conversationId:s}=e,{user:t}=(0,a.a)(),{messages:i,loading:c,loadMessages:x,sendMessage:h,markAsRead:m,conversations:u}=(0,n.R)(),p=u.find(e=>e.id===s),f=i[s]||[];(0,l.useEffect)(()=>{s&&(x(s),m(s))},[s,x,m]);let g=async e=>{await h(s,e),m(s)};return p?(0,r.jsxs)("div",{className:"flex-1 flex flex-col h-full",children:[(0,r.jsx)("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:(null==t?void 0:t.role)==="customer"?p.providerBusinessName||p.providerName||"Майстор":p.customerName||"Клиент"}),(null==t?void 0:t.role)==="customer"&&p.providerServiceCategory?(0,r.jsx)("p",{className:"text-sm text-gray-500",children:p.providerServiceCategory}):(0,r.jsx)("p",{className:"text-sm text-gray-500",children:p.customerEmail})]}),(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[(0,r.jsx)("div",{className:"w-2 h-2 rounded-full bg-green-500"}),(0,r.jsx)("span",{children:"Свързан"})]})})]})}),(0,r.jsx)(o,{messages:f,loading:c}),(0,r.jsx)(d,{onSend:g,disabled:c})]}):(0,r.jsx)("div",{className:"flex-1 flex items-center justify-center bg-gray-50",children:(0,r.jsxs)("div",{className:"text-center text-gray-500",children:[(0,r.jsx)("svg",{className:"w-16 h-16 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),(0,r.jsx)("p",{className:"text-lg font-medium",children:"Изберете разговор"}),(0,r.jsx)("p",{className:"text-sm mt-1",children:"Изберете разговор от списъка вляво"})]})})}function h(){let{conversations:e,activeConversationId:s,setActiveConversation:t,loading:a}=(0,n.R)(),[c,o]=(0,l.useState)(!1);return(0,r.jsxs)("div",{className:"h-screen flex flex-col bg-gray-100",children:[(0,r.jsx)("div",{className:"bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-4 shadow-lg",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[c&&(0,r.jsx)("button",{onClick:()=>{o(!1),t(null)},className:"md:hidden p-2 hover:bg-white/10 rounded-lg transition",children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-2xl font-bold",children:"Съобщения"}),(0,r.jsxs)("p",{className:"text-sm text-purple-100",children:[e.length," ",1===e.length?"разговор":"разговора"]})]})]}),(0,r.jsx)("button",{onClick:()=>window.location.reload(),className:"p-2 hover:bg-white/10 rounded-lg transition",title:"Обнови",children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]})}),(0,r.jsxs)("div",{className:"flex-1 flex overflow-hidden",children:[(0,r.jsx)("div",{className:"\n          w-full md:w-96 border-r border-gray-200 bg-white\n          ".concat(c?"hidden md:block":"block","\n        "),children:(0,r.jsx)(i,{conversations:e,activeConversationId:s,onSelectConversation:e=>{t(e),o(!0)},loading:a})}),(0,r.jsx)("div",{className:"\n          flex-1 bg-gray-50\n          ".concat(c?"block":"hidden md:block","\n        "),children:s?(0,r.jsx)(x,{conversationId:s}):(0,r.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center text-gray-500",children:[(0,r.jsx)("svg",{className:"w-24 h-24 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),(0,r.jsx)("p",{className:"text-xl font-medium mb-2",children:"Добре дошли в съобщенията"}),(0,r.jsx)("p",{className:"text-sm",children:"Изберете разговор от списъка вляво за да започнете"})]})})})]})]})}var m=t(9376);function u(){let{isAuthenticated:e,isLoading:s}=(0,a.a)(),t=(0,m.useRouter)();return((0,m.useSearchParams)().get("conversation"),(0,l.useEffect)(()=>{s||e||t.push("/auth/login")},[e,s,t]),s)?(0,r.jsx)("div",{className:"h-screen flex items-center justify-center",children:(0,r.jsxs)("div",{className:"inline-flex items-center gap-2 text-gray-500",children:[(0,r.jsxs)("svg",{className:"animate-spin h-8 w-8",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),(0,r.jsx)("span",{children:"Зареждане..."})]})}):e?(0,r.jsx)(h,{}):null}function p(){return(0,r.jsx)(l.Suspense,{fallback:(0,r.jsx)("div",{className:"h-screen flex items-center justify-center",children:(0,r.jsxs)("div",{className:"inline-flex items-center gap-2 text-gray-500",children:[(0,r.jsxs)("svg",{className:"animate-spin h-8 w-8",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),(0,r.jsx)("span",{children:"Зареждане..."})]})}),children:(0,r.jsx)(u,{})})}}},function(e){e.O(0,[301,680,924,103,971,117,744],function(){return e(e.s=9341)}),_N_E=e.O()}]);