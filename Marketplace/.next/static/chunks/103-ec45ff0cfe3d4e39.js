"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[103],{5090:function(e,t,n){n.d(t,{Z:function(){return o}});var s=n(7437);n(2265);var a=n(4362);function o(e){let{message:t,showSenderName:n=!0}=e,{user:o}=(0,a.a)(),c=t.senderUserId===(null==o?void 0:o.id);return(0,s.jsx)("div",{className:"flex ".concat(c?"justify-end":"justify-start"," mb-3"),children:(0,s.jsxs)("div",{className:"max-w-[70%] ".concat(c?"items-end":"items-start"," flex flex-col"),children:[!c&&n&&(0,s.jsx)("span",{className:"text-xs text-gray-500 mb-1 px-2",children:t.senderName}),(0,s.jsxs)("div",{className:"\n            px-4 py-2 rounded-lg break-words\n            ".concat(c?"bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-br-none":"bg-gray-200 text-gray-900 rounded-bl-none","\n            ").concat(t.deletedAt?"opacity-50 italic":"","\n          "),children:[t.deletedAt?(0,s.jsx)("span",{className:"text-sm",children:"Това съобщение е изтрито"}):(0,s.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:t.body}),t.editedAt&&!t.deletedAt&&(0,s.jsx)("span",{className:"text-xs ".concat(c?"text-purple-200":"text-gray-500"," ml-2"),children:"(редактирано)"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-1 mt-1 px-2 ".concat(c?"flex-row-reverse":"flex-row"),children:[(0,s.jsx)("span",{className:"text-xs text-gray-500",children:new Date(t.sentAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})}),c&&(0,s.jsx)("span",{className:"text-xs",children:t.isRead?(0,s.jsx)("span",{className:"text-blue-500",title:"Прочетено",children:"✓✓"}):(0,s.jsx)("span",{className:"text-gray-400",title:"Изпратено",children:"✓"})})]}),t.attachments&&t.attachments.length>0&&(0,s.jsx)("div",{className:"mt-2 space-y-2",children:t.attachments.map(e=>(0,s.jsx)("div",{className:"rounded-lg overflow-hidden",children:e.mimeType.startsWith("image/")?(0,s.jsx)("img",{src:e.url,alt:"Attachment",className:"max-w-full h-auto rounded-lg cursor-pointer hover:opacity-90 transition",onClick:()=>window.open(e.url,"_blank")}):(0,s.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"\n                      flex items-center gap-2 px-3 py-2 rounded-lg\n                      ".concat(c?"bg-purple-700 text-white":"bg-gray-300 text-gray-900","\n                      hover:opacity-80 transition\n                    "),children:[(0,s.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),(0,s.jsx)("span",{className:"text-sm truncate",children:"Файл"})]})},e.id))})]})})}},7829:function(e,t,n){n.d(t,{a:function(){return d},R:function(){return u}});var s=n(7437),a=n(2265),o=n(1837);class c{static async getConversations(e){return(await o.x.client.get("/chat/conversations",{params:e})).data.data}static async createConversation(e){return(await o.x.client.post("/chat/conversations",e)).data.data}static async getConversation(e){return(await o.x.client.get("/chat/conversations/".concat(e))).data.data}static async getMessages(e,t){return(await o.x.client.get("/chat/conversations/".concat(e,"/messages"),{params:t})).data.data}static async sendMessage(e,t){return(await o.x.client.post("/chat/conversations/".concat(e,"/messages"),t)).data.data}static async editMessage(e,t){return(await o.x.client.patch("/chat/messages/".concat(e),{body:t})).data.data}static async deleteMessage(e){await o.x.client.delete("/chat/messages/".concat(e))}static async markAsRead(e){await o.x.client.post("/chat/conversations/".concat(e,"/read"))}static async updateReceipt(e,t){await o.x.client.post("/chat/messages/".concat(e,"/receipts"),{status:t})}static async getReceipts(e){return(await o.x.client.get("/chat/messages/".concat(e,"/receipts"))).data.data}}var r=n(4362),i=n(6252);let l=(0,a.createContext)(void 0);function d(e){let{children:t,initialConversationId:n}=e,{user:o,isAuthenticated:d}=(0,r.a)(),{socket:u,isConnected:g}=(0,i.s)(),[m,v]=(0,a.useState)([]),[p,h]=(0,a.useState)(n||null),[x,f]=(0,a.useState)({}),[D,y]=(0,a.useState)(!1),[k,w]=(0,a.useState)(g),C=(0,a.useRef)(u);(0,a.useEffect)(()=>{C.current=u,w(g)},[u,g]),(0,a.useEffect)(()=>{if(!u||!d){console.log("⏸️ ChatContext - Waiting for socket and authentication");return}return console.log("✅ ChatContext - Setting up socket event listeners"),u.on("message:new",e=>{var t,n,s,a;console.log("\uD83D\uDCE8 New message received via message:new:",e),console.log("\uD83D\uDCE8 Message details:",{conversationId:e.conversationId,messageId:null===(t=e.message)||void 0===t?void 0:t.id,senderUserId:null===(n=e.message)||void 0===n?void 0:n.senderUserId,currentUserId:null==o?void 0:o.id,body:null===(a=e.message)||void 0===a?void 0:null===(s=a.body)||void 0===s?void 0:s.substring(0,50)}),f(t=>{let n=t[e.conversationId]||[];return n.some(t=>t.id===e.message.id)?(console.log("⚠️ Message already exists, skipping:",e.message.id),t):(console.log("✅ Adding new message from socket:",e.message.id),{...t,[e.conversationId]:[...n,e.message]})}),v(t=>t.map(t=>t.id===e.conversationId?{...t,lastMessage:e.message,lastMessageAt:e.message.sentAt}:t))}),u.on("message:updated",e=>{console.log("✏️ Message updated:",e),f(t=>({...t,[e.message.conversationId]:(t[e.message.conversationId]||[]).map(t=>t.id===e.message.id?e.message:t)}))}),u.on("message:deleted",e=>{console.log("\uD83D\uDDD1️ Message deleted:",e),f(t=>{let n={...t};return Object.keys(n).forEach(t=>{n[t]=n[t].filter(t=>t.id!==e.messageId)}),n})}),u.on("typing",e=>{console.log("⌨️ Typing indicator:",e)}),u.on("presence",e=>{console.log("\uD83D\uDC64 Presence update:",e)}),u.on("conversation:updated",e=>{console.log("\uD83D\uDD04 Conversation updated:",e),v(t=>t.map(t=>t.id===e.conversationId?{...t,lastMessageAt:e.lastMessageAt}:t))}),()=>{console.log("\uD83E\uDDF9 ChatContext - Cleaning up event listeners"),u.off("message:new"),u.off("message:updated"),u.off("message:deleted"),u.off("typing"),u.off("presence"),u.off("conversation:updated")}},[null==u?void 0:u.id]),(0,a.useEffect)(()=>{if(!C.current||!p){console.log("\uD83D\uDD0D Join conversation check:",{hasSocket:!!C.current,activeConversationId:p,connected:k});return}return console.log("\uD83D\uDEAA Joining conversation room: ".concat(p)),console.log("\uD83D\uDD0C Socket state:",{connected:C.current.connected,id:C.current.id}),C.current.emit("join-conversation",p),console.log("✅ Emitted join-conversation for: ".concat(p)),()=>{C.current&&p&&(console.log("\uD83D\uDEAA Leaving conversation: ".concat(p)),C.current.emit("leave-conversation",p))}},[p,k]);let b=(0,a.useCallback)(async()=>{try{y(!0);let e=await c.getConversations();v(e.conversations)}catch(e){console.error("Error loading conversations:",e)}finally{y(!1)}},[]),j=(0,a.useCallback)(async e=>{try{y(!0);let t=await c.getMessages(e);f(n=>({...n,[e]:t.messages}))}catch(e){console.error("Error loading messages:",e)}finally{y(!1)}},[]),E=(0,a.useCallback)(async function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text";try{var s;if(!(null===(s=C.current)||void 0===s?void 0:s.connected))throw Error("Socket not connected");console.log("\uD83D\uDCE4 Sending message via socket:",{conversationId:e,bodyPreview:t.substring(0,50),type:n,socketConnected:C.current.connected}),C.current.emit("message:send",{conversationId:e,type:n,body:t}),console.log("✅ Message sent via socket, waiting for confirmation...")}catch(e){throw console.error("Error sending message:",e),e}},[o]),N=(0,a.useCallback)(async e=>{try{await c.markAsRead(e),f(t=>({...t,[e]:(t[e]||[]).map(e=>({...e,isRead:!0}))})),v(t=>t.map(t=>t.id===e?{...t,unreadCount:0}:t))}catch(e){console.error("Error marking as read:",e)}},[]);(0,a.useEffect)(()=>{d&&b()},[d,b]);let I={conversations:m,activeConversationId:p,messages:x,loading:D,connected:k,setActiveConversation:h,loadConversations:b,loadMessages:j,sendMessage:E,markAsRead:N,socket:C.current};return(0,s.jsx)(l.Provider,{value:I,children:t})}function u(){let e=(0,a.useContext)(l);if(!e)throw Error("useChat must be used within ChatProvider");return e}},6252:function(e,t,n){n.d(t,{s:function(){return i},w:function(){return l}});var s=n(7437),a=n(2265),o=n(8680),c=n(4362);let r=(0,a.createContext)({socket:null,isConnected:!1}),i=()=>(0,a.useContext)(r);function l(e){let{children:t}=e,[n,i]=(0,a.useState)(null),[l,d]=(0,a.useState)(!1),{isAuthenticated:u}=(0,c.a)();return(0,a.useEffect)(()=>{let e="https://maystorfix.com/api/v1".replace("/api/v1","");console.log("\uD83D\uDD0C Connecting to Socket.IO /chat namespace:","".concat(e,"/chat"));let t=(0,o.io)("".concat(e,"/chat"),{auth:{token:localStorage.getItem("auth_token")||localStorage.getItem("token")},transports:["websocket","polling"],timeout:1e4,reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3,path:"/socket.io"});return t.on("connect",()=>{console.log("✅ Socket.IO connected:",t.id),d(!0)}),t.on("disconnect",e=>{console.log("\uD83D\uDD0C Socket.IO disconnected:",e),d(!1)}),t.on("connect_error",e=>{console.error("❌ Socket.IO connection error:",e),d(!1)}),t.on("reconnect",e=>{console.log("\uD83D\uDD04 Socket.IO reconnected after",e,"attempts"),d(!0)}),i(t),()=>{console.log("\uD83E\uDDF9 SocketContext unmounting - disconnecting socket"),t.disconnect()}},[]),(0,s.jsx)(r.Provider,{value:{socket:n,isConnected:l},children:t})}}}]);